<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Course Quiz</title>
  <style>
    :root{
      --bg-dark:#0a0e1a;
      --bg-medium:#0f1724;
      --card-bg:#131a2b;
      --card-hover:#182033;
      --text-primary:#e8f0f8;
      --text-secondary:#9ca3af;
      --accent:#06b6d4;
      --accent-hover:#0891b2;
      --border:rgba(255,255,255,0.06);
      --shadow:rgba(0,0,0,0.4);
      --correct-bg: rgba(22, 163, 74, 0.1);
      --correct-border: #16a34a;
      --incorrect-bg: rgba(220, 38, 38, 0.1);
      --incorrect-border: #dc2626;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:linear-gradient(135deg,#0a0e1a 0%,#0f1724 50%,#071b2a 100%);
      color:var(--text-primary);
      min-height:100vh;
      line-height:1.6;
      padding:20px;
    }
    .container{max-width:1200px;margin:0 auto}
    
    header{
      background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(6,182,212,0.05));
      border-radius:16px;
      padding:24px;
      margin-bottom:24px;
      border:1px solid var(--border);
      backdrop-filter:blur(10px);
    }
    
    .header-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:16px;
    }
    
    h1{
      font-size:24px;
      font-weight:700;
      background:linear-gradient(135deg,#06b6d4,#0891b2);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .back-btn{
      padding:10px 20px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.05);
      color:var(--text-primary);
      cursor:pointer;
      transition:all 0.3s ease;
      text-decoration:none;
      display:inline-block;
      font-size:14px;
    }
    .back-btn:hover{
      background:var(--accent);
      color:#042029;
      transform:translateY(-2px);
    }
    
    /* --- Chapter Styles --- */
    .chapter-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    .chapter-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .chapter-card:hover {
        transform: translateY(-5px);
        background: var(--card-hover);
        border-color: var(--accent);
    }
    .chapter-card h3 {
        font-size: 20px;
        color: var(--accent);
        margin-bottom: 8px;
    }
    .chapter-card p {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .quiz-container{
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .question-card{
      background:var(--card-bg);
      border-radius:14px;
      border:1px solid var(--border);
      padding: 24px;
      transition: all 0.3s ease;
    }
    
    /* --- IMAGE STYLES --- */
    .question-image-container {
        margin-bottom: 20px;
        text-align: center;
        min-height: 100px; /* Prevent total collapse before load */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .question-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        border: 1px solid var(--border);
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        display: inline-block;
        
        /* Lazy Load Animations */
        opacity: 0;
        transition: opacity 0.5s ease-in;
    }

    .question-image.loaded {
        opacity: 1;
    }
    
    /* Placeholder loader */
    .image-placeholder {
        color: var(--text-secondary);
        font-size: 14px;
        font-style: italic;
    }
    
    .question-text {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }

    .option {
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: rgba(255,255,255,0.03);
    }
    .option:hover {
        background-color: var(--card-hover);
        border-color: var(--accent);
    }
    .option.selected {
        background-color: var(--accent);
        color: #042029;
        font-weight: bold;
        border-color: var(--accent-hover);
    }
    
    .option.correct { background-color: var(--correct-bg); border-color: var(--correct-border);color: #ffffff; }
    .option.incorrect { background-color: var(--incorrect-bg); border-color: var(--incorrect-border);}


    .feedback {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        font-weight: 500;
        display: none;
        line-height: 1.7;
    }
    .feedback.correct { background-color: var(--correct-bg); border: 1px solid var(--correct-border); color: var(--correct-border); display: block; font-weight: bold; }
    .feedback.incorrect { background-color: var(--incorrect-bg); border: 1px solid var(--incorrect-border); color: var(--text-primary); display: block; }
    .feedback strong {
        display: block;
        margin-bottom: 8px;
        font-weight: 700;
        color: var(--incorrect-border);
    }
    
    .empty-state{
      text-align:center;
      padding:80px 20px;
      color:var(--text-secondary);
      background: var(--card-bg);
      border-radius: 14px;
    }
    .empty-icon{font-size:64px;margin-bottom:16px;opacity:0.5}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-top">
        <h1 id="pageTitle">Course Quiz</h1>
        <a href="courses.html" class="back-btn">← Back to Courses</a>
      </div>
    </header>

    <div class="chapter-container" id="chapterContainer">
      </div>
    
    <div class="quiz-container" id="quizContainer" style="display: none;">
      </div>
  </div>

  <script>
    window.courseData = {};
    window.questionsByChapter = {};
    window.currentQuestions = [];
    window.currentCourseCode = '';
    
    let userAnswers = {};
    let imageObserver = null;

    function escapeHtml(text) {
      return String(text).replace(/[&<>"']/g, (m) => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#039;'}[m]));
    }
    
    function groupQuestions(questions) {
        return questions.reduce((acc, q) => {
            const chapter = q.chapter || 'General';
            if (!acc[chapter]) {
                acc[chapter] = [];
            }
            acc[chapter].push(q);
            return acc;
        }, {});
    }

    function initializeApp(data) {
      const urlParams = new URLSearchParams(window.location.search);
      window.currentCourseCode = urlParams.get('code') || '';
      
      document.getElementById('pageTitle').textContent = `Quizzes for ${window.currentCourseCode}`;
      
      const quizzesData = data.quizzes || {};
      const courseQuestions = quizzesData[window.currentCourseCode] || [];
      
      if (!courseQuestions.length) {
          document.getElementById('chapterContainer').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">❓</div>
              <h3>No Questions Available for This Course</h3>
              <p>Questions will be added soon.</p>
            </div>
          `;
          return;
      }
      
      window.questionsByChapter = groupQuestions(courseQuestions);
      renderChapterList(Object.keys(window.questionsByChapter).sort());
    }

    function renderChapterList(chapterNames) {
        const container = document.getElementById('chapterContainer');
        container.innerHTML = chapterNames.map(name => `
            <div class="chapter-card" onclick="selectChapter('${escapeHtml(name)}')">
              <h3>${escapeHtml(name)}</h3>
              <p>${window.questionsByChapter[name].length} questions</p>
            </div>
        `).join('');
    }

    function selectChapter(chapterName) {
        window.currentQuestions = window.questionsByChapter[chapterName];
        userAnswers = {};
        
        renderQuiz(window.currentQuestions);
        
        document.getElementById('chapterContainer').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'flex';
        document.getElementById('pageTitle').textContent = `${window.currentCourseCode}: ${chapterName}`;
        
        const backBtn = document.querySelector('.back-btn');
        backBtn.textContent = '← Back to Chapters';
        backBtn.href = '#';
        backBtn.onclick = (e) => {
            e.preventDefault();
            showChapterList();
        };
    }
    
    function showChapterList() {
        document.getElementById('chapterContainer').style.display = 'grid';
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('quizContainer').innerHTML = '';
        document.getElementById('pageTitle').textContent = `Quizzes for ${window.currentCourseCode}`;
        
        const backBtn = document.querySelector('.back-btn');
        backBtn.textContent = '← Back to Courses';
        backBtn.href = 'courses.html';
        backBtn.onclick = null;
    }

    function renderQuiz(questions) {
      const container = document.getElementById('quizContainer');
      
      // Render logic
      container.innerHTML = questions.map((q, index) => `
        <div class="question-card" id="question-${index}">
          
          ${q.image_base64 ? `
            <div class="question-image-container">
                <img 
                    data-index="${index}" 
                    class="question-image lazy-load" 
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                    alt="Question Image"
                >
            </div>
          ` : ''}
          
          <p class="question-text">${index + 1}. ${escapeHtml(q.question)}</p>
          <div class="options-grid">
            ${q.options.map((opt, optIndex) => `
              <div class="option" onclick="selectOption(this, ${index}, ${optIndex})">
                ${escapeHtml(opt)}
              </div>
            `).join('')}
          </div>
          <div class="feedback" id="feedback-${index}"></div>
        </div>
      `).join('');

      // Initialize the lazy loader after rendering HTML
      setupLazyLoading();
    }

    // --- LAZY LOADING LOGIC ---
    function setupLazyLoading() {
        // Disconnect previous observer if exists
        if (imageObserver) {
            imageObserver.disconnect();
        }

        // Create new observer
        imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const index = img.dataset.index;
                    
                    // Retrieve Base64 from memory only when needed
                    if (window.currentQuestions[index] && window.currentQuestions[index].image_base64) {
                        img.src = window.currentQuestions[index].image_base64;
                        
                        img.onload = () => {
                            img.classList.add('loaded');
                            img.classList.remove('lazy-load');
                        };
                    }
                    
                    // Stop observing this image
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: "200px 0px", // Start loading 200px before the image enters viewport
            threshold: 0.01
        });

        // Observe all images with class 'lazy-load'
        const lazyImages = document.querySelectorAll('.lazy-load');
        lazyImages.forEach(img => imageObserver.observe(img));
    }

    function selectOption(element, questionIndex, optionIndex) {
        const questionCard = document.getElementById(`question-${questionIndex}`);
        const allOptions = questionCard.querySelectorAll('.option');

        if (questionCard.classList.contains('answered')) return;

        allOptions.forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        
        userAnswers[questionIndex] = optionIndex;
        
        checkAnswer(questionIndex);
    }
    
    function checkAnswer(questionIndex) {
        const question = window.currentQuestions[questionIndex];
        const selectedOptionIndex = userAnswers[questionIndex];

        const feedbackEl = document.getElementById(`feedback-${questionIndex}`);
        const questionCard = document.getElementById(`question-${questionIndex}`);
        const options = questionCard.querySelectorAll('.option');
        
        questionCard.classList.add('answered');

        if (selectedOptionIndex === question.answer_index) {
            feedbackEl.textContent = 'Correct Answer!';
            feedbackEl.className = 'feedback correct';
            options[selectedOptionIndex].classList.add('correct');
        } else {
            const explanation = question.explanation || 'No explanation provided.';
            feedbackEl.innerHTML = `<strong>Incorrect.</strong> ${escapeHtml(explanation)}`;
            feedbackEl.className = 'feedback incorrect';
            if(selectedOptionIndex !== undefined) {
               options[selectedOptionIndex].classList.add('incorrect');
            }
            options[question.answer_index].classList.add('correct');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetch('quiz.json')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
          window.courseData = data;
          initializeApp(data);
        })
        .catch(error => {
          console.error('Error loading quiz data:', error);
          document.getElementById('chapterContainer').innerHTML = '<p style="color:red; text-align:center;">Failed to load quiz data.</p>';
        });
    });
  </script>
</body>
</html>